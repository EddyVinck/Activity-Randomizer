<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Plan a Random Activity â€” Google Sheets integration</title>
  <meta description="Plan activities picked from your own Google Sheet. Add them to your Google Calendar.">
</head>

<body>
  <nav class="site-nav sticky-top py-1 mb-4">
    <div class="container d-flex flex-column flex-md-row">
      <a class="py-2 px-2 d-inline-block d-sm-inline-block" href="#">
        Activity Randomizer<!-- <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="d-block mx-auto"><circle cx="12" cy="12" r="10"></circle><line x1="14.31" y1="8" x2="20.05" y2="17.94"></line><line x1="9.69" y1="8" x2="21.17" y2="8"></line><line x1="7.38" y1="12" x2="13.12" y2="2.06"></line><line x1="9.69" y1="16" x2="3.95" y2="6.06"></line><line x1="14.31" y1="16" x2="2.83" y2="16"></line><line x1="16.62" y1="12" x2="10.88" y2="21.94"></line></svg> -->
      </a>
      <a href="/help" class="py-2 px-2 d-inline-block d-sm-inline-block">Help</a>
      <a class="py-2 px-2 d-inline-block d-sm-inline-block" href="#">
        <button class="btn btn-primary float-right" id="authorize-button" style="display: none;">Authorize</button>
        <button class="btn btn-secondary btn-sm float-right" id="signout-button" style="display: none;">Sign Out</button>
      </a>
    </div>
  </nav>

  <div class="container">
  
    <div class="mb-2">
      <div class="row justify-content-start">
        <div class="col-12 col-sm-10 col-md-6 col-lg-5">
          <h1>Activity Randomizer</h1>
          <p>Have you ever felt like doing something, but then not being able to pick an activity to do?</p>
          <p><i>This project will use the Google Sheets API, Google Calendar API and the Google Custom Search API(for images based on the random activity)</i></p>         
          
          <div class="mb-4">            
            <div>
              <div class="form-group">
                <label class="d-block d-sm-inline-block" for="sheet-input">Sheet:</label>
                <input type="text" placeholder="Enter your sheet ID" id="sheet-input" name="sheet-input">
                <button class="btn" id="clear-input">Clear</button>
              </div>
              <!-- The dropdown with the sheets in the document -->
              <div class="input-container">
                <label>
                  Pick a Sheet
                  <select name="" id="sheet-names" style="display: none;"></select>
                </label>
              </div>
              <div class="input-container">
                <button id="sheet-submit" class="btn btn-primary" type="button">Import sheet</button>
                <button class="btn btn-light" id="pick-activity">Pick an activity</button>
              </div>
            </div>            
          </div>            
          <div sheet-content class="row d-none d-md-block"></div>         
        </div>        
        <div class="col-12 col-sm-10 col-md-5 offset-md-1 col-lg-4 offset-lg-1">
          <div class="mb-2">
            <div class="card" id="picked-activity">
              <div class="card-img-top">
                <!-- https://developers.google.com/custom-search/ -->
                <img src="https://picsum.photos/200/100" width="100%" alt="">
              </div>
              <div class="card-body">
                <div class="card-title">
                  <h2 class="h4">Picked activity name</h2>
                </div>
                <div class="card-text">
                  <p>Based on  <strike>no parameters</strike> fate.</p>
                  <a href="#" class="btn btn-primary">Add to Calendar</a>
                </div>
              </div>
            </div>
          </div>          
        </div>        
      </div>
    </div>
    
    <div class="row d-block d-md-none">
      <div class="col-12 col-md-6">
        <h2 class="h4">Your activities: </h2>
        <div sheet-content class="row"></div>
      </div>
    </div>

  </div>
  

  <script type="text/javascript">
    // Client ID and API key from the Developer Console
    var CLIENT_ID = '855790869281-iie5tqafurs5179pmr8s236n595o4460.apps.googleusercontent.com';
    var API_KEY = 'AIzaSyDxKJyIUDRnU7xTz6_CWAGxZkDiytZtpA4';

    // Array of API discovery doc URLs for APIs used by the quickstart
    var DISCOVERY_DOCS = [
      "https://sheets.googleapis.com/$discovery/rest?version=v4",
      "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"
    ];

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    var SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/calendar.readonly";

    var documentID = '1hqNuYTfAguDAXDWA9L14BarfqwVOWSGsd6IpuWNX2BE';

    var authorizeButton = document.getElementById('authorize-button');
    var signoutButton = document.getElementById('signout-button');
    var documentInput = document.getElementById('sheet-input');
    var sheetSubmit = document.getElementById('sheet-submit');
    var sheetDropdown = document.getElementById('sheet-names');
    var pickBtn = document.getElementById('pick-activity');
    var pickedActivity = document.getElementById('picked-activity');
    var sheetContentContainer = document.querySelectorAll('[sheet-content]');

    // The activities array will hold all activities from a sheet
    var activities = [];

    /**
     *  On load, called to load the auth2 library and API client library.
     *  Calls initClient.
     */
    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    /**
     *  Initializes the API client library and sets up sign-in state
     *  listeners.
     */
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function () {
        // Listen for sign-in state changes.
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        // Handle the initial sign-in state.
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;
      });
    }

    /**
     *  Called when the signed in status changes, to update the UI
     *  appropriately. After a sign-in, the API is called.
     */
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'block';
        listActivities(documentID);
      } else {
        authorizeButton.style.display = 'block';
        signoutButton.style.display = 'none';
      }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick(event) {
      gapi.auth2.getAuthInstance().signIn();
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick(event) {
      gapi.auth2.getAuthInstance().signOut();
    }

    /**
     * Append a pre element to the body containing the given message
     * as its text node. Used to display the results of the API call.
     *
     * @param {string} message Text to be placed in pre element.
     */
    function appendPre(message) {
      var content = document.querySelectorAll('content');
      var textContent = document.createTextNode(message + '\n');
      content.appendChild(textContent);
    }
    function appendCol(thing, time) {
      sheetContentContainer.forEach(contentContainer => {
        var col = document.createElement("div");
        var textContent = document.createTextNode(thing + ", " + time + " minutes." + '\n');
        col.classList.add("col-sm-12");
        col.appendChild(textContent);
        contentContainer.appendChild(col);
      })
    }

    /**
     * Print the names and majors of students in a sample spreadsheet:
     * https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit
     */
    function listActivities(documentID, sheetName) {
      sheetName = sheetName ? (sheetName + '!') : '';
      sheetContentContainer.forEach(ct => ct.innerHTML = '<div class="col">Loading data...</div>');
      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: documentID || '1hqNuYTfAguDAXDWA9L14BarfqwVOWSGsd6IpuWNX2BE',
        range: sheetName + 'A2:D',
      }).then(function (response) {
        var range = response.result;
        
        // Sometimes range.values has no values so it is not returned from the response
        // This is why it needs to be checked before the length is checked.
        if (range.values && range.values.length > 0) {      
          // Reset the activities array
          activities = [];

          sheetContentContainer.forEach(ct => ct.innerHTML = '');
          for (i = 0; i < range.values.length; i++) {
            var row = range.values[i];

            // Print columns A and B, which correspond to indices 0 and 1.
            appendCol(row[0],row[1]);

            activities.push({
              activity: row[0],
              time: row[1],
              rating: row[2],
              description: row[3] || 'No description'
            });
            getSheetNames(documentID);
          }
        } else {
          sheetContentContainer.forEach(ct => ct.innerHTML = '<div class="col">No data found. :(</div>');
        }
      }, function (response) {
        appendPre('Error: ' + response.result.error.message);
      });
    }

    function getSheetNames(documentID) {
      gapi.client.sheets.spreadsheets.get({
        spreadsheetId: documentID
      }).then(function(response) {
        // console.log("Sheet names response");
        // console.log(response);

        insertSheetNames(response.result.sheets, sheetDropdown); // array        
      }, function(reason) {
        console.error('error: ' + reason.result.error.message);
      });
    }

    function getSheet(documentID, sheetName) {
      listActivities(documentID, sheetName);
    }

    function insertSheetNames(sheetNames, select) {
      select.style.display = "inline-block";
      select.innerHTML = '';
      sheetNames.forEach(sheet => {
        let option = document.createElement('option');
        option.text = sheet.properties.title;
        option.value = sheet.properties.title;
        select.appendChild(option);
      });
    }

    function insertPickedActivity(pick) {
      pickedActivity.querySelector('.card-title h2').innerHTML = pick.activity;
      pickedActivity.querySelector('.card-text').innerHTML = pick.time + ' minutes. <br>' + pick.description;
    }

    sheetDropdown.addEventListener('change', (event) => {
      documentID = documentInput.value == '' ? documentID : documentInput.value;
      let sheetName = event.target.value;
      listActivities(documentID, sheetName);
    });

    sheetSubmit.addEventListener('click', function() {
      getSheet(documentInput.value);
      if(documentInput.value != '') {
        getSheetNames(documentInput.value);
      } else {
        getSheetNames(documentID);
      }
    });

    pickBtn.addEventListener('click', () => {
      // TODO: filters.. Min and max time, min and max amount of people, 
      var filteredActivities = [];

      if(activities.length > 0) {
        let random = Math.floor(Math.random()*activities.length);
        insertPickedActivity(activities[random]);
      }
      
    });

    document.getElementById('clear-input').addEventListener('click', function() {
      documentInput.value = '';
    });

  </script>

  <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()" onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>
</body>

</html>