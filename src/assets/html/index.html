<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Plan Random activities â€” Google Sheets integration</title>
  <meta description="Plan activities picked from your own Google Sheet. Add them to your Google Calendar with ease.">
</head>

<body>    
  <!-- Modal -->
  <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">Modal title</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div sheet-content=""></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- end modal -->

  <nav class="site-nav sticky-top py-1 mb-3">
    <div class="container d-flex flex-column flex-md-row">
      <a class="py-2 pr-3 d-inline-block d-sm-inline-block" href="#">
        Activity Randomizer [alpha]<!-- <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="d-block mx-auto"><circle cx="12" cy="12" r="10"></circle><line x1="14.31" y1="8" x2="20.05" y2="17.94"></line><line x1="9.69" y1="8" x2="21.17" y2="8"></line><line x1="7.38" y1="12" x2="13.12" y2="2.06"></line><line x1="9.69" y1="16" x2="3.95" y2="6.06"></line><line x1="14.31" y1="16" x2="2.83" y2="16"></line><line x1="16.62" y1="12" x2="10.88" y2="21.94"></line></svg> -->
      </a>
      <a href="/help" class="py-2 px-3 d-inline-block d-sm-inline-block">Help</a>
      <a href="/example-sheet" class="py-2 px-3 d-inline-block d-sm-inline-block">Example Sheet</a>
      <a href="/settings" class="py-2 px-3 d-inline-block d-sm-inline-block">Settings</a>
      <a class="py-2 px-3 d-inline-block d-sm-inline-block" href="#">
        <button class="btn btn-primary float-right" id="authorize-button" style="display: none;">Authorize</button>
        <button class="btn btn-secondary btn-sm float-right" id="signout-button" style="display: none;">Sign Out</button>
      </a>
    </div>
  </nav>
  <!-- <div class="modal-overlay">
    <div class="modal-wrapper">
      <div class="modal">
        <div class="modal-content">
          <div sheet-content>

          </div>
        </div>
      </div>
    </div>
  </div> -->
  <!-- Button trigger modal -->
  
  
  <div class="container">
    <div class="spaceholder-top mb-4">
      
    </div>
    <div class="mb-2">
      <div class="row justify-content-start">
        <div class="col-12 col-sm-10 col-md-6 col-lg-7">
          <h1>Activity Randomizer</h1>
          <h2>Insert a Google Sheet link to get started!</h2>

          <div class="mb-4">            
            <div>
              <div class="step">
                <h3>Step 1/4: add a document link</h3>
              </div>
              <div class="">
                <div class="form-row">
                  <div class="col-9">
                    <input class="form-control" type="text" placeholder="docs.google.com/spreadsheets/. . ." id="sheet-input" name="sheet-input">
                  </div>
                  <div class="col-3">
                    <button id="sheet-submit" class="btn btn-primary" type="button">Import</button>
                  </div>
                </div>
                <!-- <label class="d-block d-sm-inline-block" for="sheet-input">Sheet:</label> -->
                <!-- <button class="btn" id="clear-input">Clear</button> -->
                <div class="input-container checkbox-container">
                  <label>
                    <span>Remember link (settings)</span>
                    <input type="checkbox" name="" id="">
                  </label>
                </div>
                <div class="help-text">
                  <p>Need help? The <a href="#">Google Sheet Import turorial</a> will guide you.</p>
                </div>              
              </div>
              <!-- The dropdown with the sheets in the document -->
              <div class="step">
                <h3>Step 2/4: pick a sheet</h3>
              </div>              
              <div class="input-container">
                <label>
                  Pick a Sheet
                  <select name="" id="sheet-names" style="display: none;"></select>
                </label>
                <div class="input-container checkbox-container">
                  <label>
                    <span>Remember sheet (settings)</span>
                    <input type="checkbox" name="" id="">
                  </label>
                </div> 
              </div>
              <div class="step">
                <h3>Step 3/4: filter (optional)</h3>
              </div>
              <div class="input-container range-container">
                <label class="d-block">
                  Maximum time (minutes) 
                </label>
                <span class="min">0</span>
                <input time-range disabled type="range" min="0" max>
                <span class="max">240</span>             
              </div>
              <div class="input-container">
                <!-- <button id="filter-submit" class="btn btn-primary">
                  Filter activities
                </button> -->
                <!-- Button trigger modal -->
                <button type="button" class="btn" data-toggle="modal" data-target="#exampleModalCenter">
                  View your current list
                </button>
                <button id="remove-filters" class="btn btn-secondary">
                  Remove filters
                </button>
              </div>
              <div class="step">
                <h3>Step 4: Generate random activity</h3>
              </div>
              <div class="input-container mt-3">
                <button class="btn btn-primary" id="pick-activity">Randomize activity</button>
              </div>
            </div>            
          </div>                     
        </div>        
        <div class="col-12 col-sm-10 col-md-5 offset-md-1 col-lg-4 offset-lg-0">
          <div class="activity-wrapper">
            <div class="no-activity">
              <p>
                This is where your randomized activity will be when you link to a Google Sheets document, pick a sheet and click <span class="block-for-large">'Randomize activity'</span>
              </p>
              <div class="process-icons">
                <!-- Document => Random => Happy  -->
              </div>
            </div>
            <div class="randomized-activity">

              <div class="mt-3 mb-2">
                <h2 class="card-explanation">Your randomized activity:</h2>
                <div class="card" id="picked-activity">
                  <div class="card-img-top">
                    <!-- https://developers.google.com/custom-search/ -->
                    <img src="https://picsum.photos/200/100" width="100%" alt="">
                  </div>
                  <div class="card-body">
                    <div class="card-title">
                      <h2 class="h4">Picked activity name</h2>
                    </div>
                    <div class="card-text">
    
                      <!-- TODO -->
                      <a href="#" disabled class="btn btn-primary disabled">Add to Google Calendar</a>
                    </div>
                  </div>
                </div>
              </div> 

            </div>
          </div>

        </div>        
      </div>
    </div>

  </div>
  

  <script type="text/javascript">
    // Client ID and API key from the Developer Console
    var CLIENT_ID = '855790869281-iie5tqafurs5179pmr8s236n595o4460.apps.googleusercontent.com';
    var API_KEY = 'AIzaSyDxKJyIUDRnU7xTz6_CWAGxZkDiytZtpA4';

    // Array of API discovery doc URLs for APIs used by the quickstart
    var DISCOVERY_DOCS = [
      "https://sheets.googleapis.com/$discovery/rest?version=v4",
      "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"
    ];

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    var SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/calendar.readonly";

    var documentID = '1hqNuYTfAguDAXDWA9L14BarfqwVOWSGsd6IpuWNX2BE';

    var authorizeButton = document.getElementById('authorize-button');
    var signoutButton = document.getElementById('signout-button');
    var documentInput = document.getElementById('sheet-input');
    var sheetSubmit = document.getElementById('sheet-submit');
    var sheetDropdown = document.getElementById('sheet-names');
    var pickBtn = document.getElementById('pick-activity');
    var pickedActivity = document.getElementById('picked-activity');
    var sheetContentContainer = document.querySelectorAll('[sheet-content]');
    var timeRange = document.querySelector('[time-range]');
    var filterSubmit = document.getElementById('filter-submit');
    var removeFiltersBtn = document.getElementById('remove-filters');

    // variable that decides if the activities should be filtered or not
    var isUsingFilters = false;

    // The activities array will hold all activities from a sheet
    var filteredActivities = [];
    var activities = [];

    /**
     *  On load, called to load the auth2 library and API client library.
     *  Calls initClient.
     */
    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    /**
     *  Initializes the API client library and sets up sign-in state
     *  listeners.
     */
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function () {
        // Listen for sign-in state changes.
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        // Handle the initial sign-in state.
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;
      });
    }

    /**
     *  Called when the signed in status changes, to update the UI
     *  appropriately. After a sign-in, the API is called.
     */
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'block';
        getSheetNames(documentID);
        listActivities(documentID);
      } else {
        authorizeButton.style.display = 'block';
        signoutButton.style.display = 'none';
      }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick(event) {
      gapi.auth2.getAuthInstance().signIn();
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick(event) {
      gapi.auth2.getAuthInstance().signOut();
    }

    /**
     * Append a pre element to the body containing the given message
     * as its text node. Used to display the results of the API call.
     *
     * @param {string} message Text to be placed in pre element.
     */
    function appendPre(message) {
      var content = document.querySelectorAll('content');
      var textContent = document.createTextNode(message + '\n');
      content.appendChild(textContent);
    }
    function appendCol(thing, time) {
      sheetContentContainer.forEach(contentContainer => {
        var col = document.createElement("div");
        var textContent = document.createTextNode(thing + ", " + time + " minutes." + '\n');
        col.classList.add("col-sm-12");
        col.appendChild(textContent);
        contentContainer.appendChild(col);
      })
    }

    /**
     * Print the names and majors of students in a sample spreadsheet:
     * https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit
     */
    function listActivities(documentID, sheetName) {
      sheetName = sheetName ? (sheetName + '!') : '';
      sheetContentContainer.forEach(ct => ct.innerHTML = '<div class="col">Loading data...</div>');
      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: documentID || '1hqNuYTfAguDAXDWA9L14BarfqwVOWSGsd6IpuWNX2BE',
        range: sheetName + 'A2:D',
      }).then(function (response) {
        var range = response.result;
        
        // Sometimes range.values has no values so it is not returned from the response
        // This is why it needs to be checked before the length is checked.
        if (range.values && range.values.length > 0) {      
          // Reset the activities array
          activities = [];

          sheetContentContainer.forEach(ct => ct.innerHTML = '');
          for (i = 0; i < range.values.length; i++) {
            var row = range.values[i];

            // Print columns A and B, which correspond to indices 0 and 1.
            appendCol(row[0],row[1]);

            activities.push({
              activity: row[0],
              time: row[1],
              rating: row[2],
              description: row[3] || 'No description'
            });
            
          }
          // getSheetNames(documentID);
          setTimeRangeMaxValue();
        } else {
          sheetContentContainer.forEach(ct => ct.innerHTML = '<div class="col">No data found. :(</div>');
          disableFilters();
        }
      }, function (response) {
        appendPre('Error: ' + response.result.error.message);
      });
    }

    function getSheetNames(documentID) {
      gapi.client.sheets.spreadsheets.get({
        spreadsheetId: documentID
      }).then(function(response) {
        // console.log("Sheet names response");
        // console.log(response);

        insertSheetNames(response.result.sheets, sheetDropdown); // array        
      }, function(reason) {
        console.error('error: ' + reason.result.error.message);
      });
    }

    function getSheet(documentID, sheetName) {
      listActivities(documentID, sheetName);
    }

    function insertSheetNames(sheetNames, select) {
      select.style.display = "inline-block";
      select.innerHTML = '';
      sheetNames.forEach(sheet => {
        let option = document.createElement('option');
        option.text = sheet.properties.title;
        option.value = sheet.properties.title;
        select.appendChild(option);
      });
    }

    function insertPickedActivity(pick) {
      pickedActivity.querySelector('.card-title h2').innerHTML = pick.activity;
      pickedActivity.querySelector('.card-text').innerHTML = pick.time + ' minutes. <br>' + pick.description;
    }

    sheetDropdown.addEventListener('change', (event) => {
      documentID = documentInput.value == '' ? documentID : documentInput.value;
      let sheetName = event.target.value;
      listActivities(documentID, sheetName);
    });

    sheetSubmit.addEventListener('click', function() {
      documentID = documentInput.value == '' ? documentID : documentInput.value;
      getSheet(documentID);
      getSheetNames(documentID);
    });

    pickBtn.addEventListener('click', () => {
      let theArrayToFilter = isUsingFilters ? filteredActivities : activities;      

      if(theArrayToFilter.length > 0) {
        let random = Math.floor(Math.random()*theArrayToFilter.length);
        insertPickedActivity(theArrayToFilter[random]);
      } else {
        console.log('No activities available');
      }
      
    });

    // document.getElementById('clear-input').addEventListener('click', function() {
    //   documentInput.value = '';
    // });

    function setTimeRangeMaxValue(activ) {
      timeRange.disabled = true;
      activ = activ || activities;
      let maxTime = null;

      maxTime = activ.reduce((accumulator, currentActivity) => {
        let time = Number(currentActivity.time);
        return time > accumulator ? time : accumulator;
        
      }, null);
      timeRange.max = maxTime;
      if(timeRange.disabled == true && timeRange.max != 'null') timeRange.disabled = false;
    }

    function disableFilters() {
      timeRange.disabled = true;
    }

    filterSubmit.addEventListener('click', () => {
      // console.log(activities);
      // console.log(filterActivities(activities));
      isUsingFilters = true;

      filteredActivities = filterActivities(activities);

      // Replace the shown activities list with the filtered list
      sheetContentContainer.forEach(ct => ct.innerHTML = '');
      if(filteredActivities.length > 0) {
        for (i = 0; i < filteredActivities.length; i++) {
          var row = filteredActivities[i];
          appendCol(row.activity,row.time);          
        }
      } else {
        sheetContentContainer.forEach(ct => ct.innerHTML = '<div class="col">Every activity was filtered out. Change your filters or click the \'Remove filters\' button to view the unfiltered list.</div>');
      }
    });

    function filterActivities(actvts) {
      // filter based on time
      let filtered = actvts.filter((activity) => {
        // Because activity.time is a string it needs to be converted
        // to a number before comparing it to the value of the time range.
        return Number(activity.time) <= timeRange.value;
      });
      return filtered;
    }

    removeFiltersBtn.addEventListener('click', () => {
      isUsingFilters = false;
    });
    

  </script>

  <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()" onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>
</body>

</html>