<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Activity Randomizer â€” Google Sheets integration</title>
  <meta description="Plan activities picked from your own Google Sheet.">
<link href="styles/main.aaa6457b0a98264a6b4d.css" rel="stylesheet"></head>

<body>    
  <!-- Activities Modal -->
  <div class="modal fade" id="viewCurrentActivities" tabindex="-1" role="dialog" aria-labelledby="viewCurrentActivities" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">Your filtered activities</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div sheet-content=""></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- end modal -->
  <!-- Settings Modal -->
  <!-- <div class="modal fade" id="viewSettings" tabindex="-1" role="dialog" aria-labelledby="viewSettings" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">Your settings</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p><strong>Remember your Google Sheets document link:</strong></p>
          <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ullam quisquam distinctio doloremque illo assumenda, corrupti incidunt vel nesciunt quibusdam culpa magni molestiae ipsum nemo ab eum voluptatem labore minima placeat!</p>
          <p><i>Your settings are currently stored in a cookie.</i></p>
          <p>Do you want to remove your cookies?</p>
          <button class="btn btn-outline-danger" data-toggle="tooltip" data-placement="top" title="The site will forget any saved settings you might have set.">Remove cookies</button>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div> -->
  <!-- end modal -->

  <nav class="navbar navbar-expand-md navbar-light site-nav sticky-top py-1 mb-3">
    <a class=" navbar-brand " href="#">
      Activity Randomizer v0.1
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="flex-flow navbar-nav flex-flow navbar-nav mb-2 mb-md-0">
        <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
        <li class="nav-item"><a href="/help" class="nav-link">Help</a></li>
        <li class="nav-item"><a href="/example-sheet" class="nav-link">Example Sheet</a></li>
        <!-- <li class="nav-item"><a data-toggle="modal" data-target="#viewSettings" href="/" class="nav-link">Settings</a></li> -->
      </ul>
      <ul class="navbar-nav ml-md-auto d-md-flex">
        <li class="nav-item">
            <button class="btn btn-primary ml-0" id="authorize-button" style="display: none;">Authorize</button>
            <button class="btn btn-secondary btn-sm ml-0" id="signout-button" style="display: none;">Sign Out</button>
        </li>
        <li class="nav-item"></li>
      </ul>
    </div>
  </nav>  
  
  <div class="container">
    <div class="spaceholder-top mb-4">
      
    </div>
    <div class="mb-2">
      <div class="row justify-content-start">
        <div class="col-12 col-sm-10 col-md-6 col-lg-7">
          <h1>Activity Randomizer</h1>
          <h2>Insert a Google Sheet link to get started!</h2>

          <div class="mb-4">            
            <div>
              <div class="step">
                <h3>Step 1/4: add a document link <i class="icon-link"></i></h3>
              </div>
              <div class="">
                <div class="form-row mb-3">
                  <div class="col-12 col-md-7 mb-2 mb-md-0">
                    <input class="form-control" type="text" placeholder="docs.google.com/spreadsheets/. . ." id="sheet-input" name="sheet-input">
                  </div>
                  <div class="col-12 col-md-5  mb-2 mb-md-0">
                    <button id="sheet-submit" class="btn btn-primary" type="button">Load document</button>
                  </div>
                </div>
                <!-- <label class="d-block d-sm-inline-block" for="sheet-input">Sheet:</label> -->
                <!-- <button class="btn" id="clear-input">Clear</button> -->
                <!-- <div class="input-container checkbox-container">
                  <label>
                    <span>Remember link (settings)</span>
                    <input type="checkbox" name="" id="">
                  </label>
                </div> -->
                <div class="help-text">
                  <p>Need help? The <a href="/sheets-import-tutorial">Google Sheet Import turorial</a> will guide you.</p>
                </div>              
              </div>
              <!-- The dropdown with the sheets in the document -->
              <div class="step">
                <h3>Step 2/4: pick a sheet</h3>
              </div>              
              <div class="input-container">
                <div class="form-row">
                  <div class="col-12 col-md-8">
                    <select class="custom-select" disabled name="" id="sheet-names">
                      <option value="">Loading sheet names...</option>
                    </select>
                  </div>
                  <!-- <div class="col-12">
                    <div class="input-container checkbox-container">
                      <label>
                        <span>Remember sheet (settings)</span>
                        <input type="checkbox" name="" id="">
                      </label>
                    </div> 
                  </div> -->
                </div>
              </div>
              <div class="step">
                <h3>Step 3/4: filter (optional)</h3>
              </div>
              <div class="input-container range-container">
                <label class="d-block">
                  Maximum time: <span time-range-value></span> (minutes) 
                </label>
                <span class="min">0</span>
                <input time-range disabled type="range" min="0" max step="5">
                <span class="max">240</span>             
              </div>
              <div class="input-container">
                <!-- Button trigger modal -->
                <button type="button" class="btn btn-light mr-2 mb-2" data-toggle="modal" data-target="#viewCurrentActivities">
                  <i class="icon-list-bullet"></i>View your filtered list
                </button>
                <button id="remove-filters" class="btn btn-secondary mb-2">
                  Reset filters
                </button>
              </div>
              <div class="step">
                <h3>Step 4: Generate random activity</h3>
              </div>
              <div class="input-container mt-3">
                <button class="btn btn-primary" id="pick-activity">Randomize activity<i class="icon-shuffle"></i></button>
              </div>
            </div>            
          </div>                     
        </div>        
        <div class="col-12 col-sm-10 col-md-5 offset-md-1 col-lg-4 offset-lg-0">
          <div class="activity-wrapper">
            <div class="no-activity mt-3">
              <p>
                This is where your randomized activity will be when you link to a 
                Google Sheets document, pick a sheet and click 
                <span class="block">'Randomize activity'</span>
                <div class="icon-wrapper text-richblack">
                  <i class="icon-doc-inv text-deepgreen"></i>
                  <i class="icon-right-bold"></i>
                  <i class="icon-shuffle text-deepgreen"></i>
                  <i class="icon-right-bold"></i>
                  <i class="icon-smile text-deepgreen"></i>
                </div>
            </div>
            <div class="randomized-activity" style="display: none;">

              <div class="mt-3 mb-2">
                <h2 class="card-explanation">Your randomized activity:</h2>
                <div class="card" id="picked-activity">
                  <div class="card-img-top">
                    <!-- https://developers.google.com/custom-search/ -->
                    <!-- <img src="https://picsum.photos/200/100" width="100%" alt=""> -->
                  </div>
                  <div class="card-body">
                    <div class="card-title">
                      <h2 class="activity-title">Picked activity name</h2>
                    </div>
                    <div class="card-text">
    
                      <!-- TODO -->
                      <!-- <a href="#" disabled class="btn btn-primary btn-block disabled">Add to Google Calendar</a> -->
                    </div>
                  </div>
                </div>
              </div> 

            </div>
          </div>

        </div>        
      </div>
    </div>

  </div>
  

  <script type="text/javascript">
    // Client ID and API key from the Developer Console
    var CLIENT_ID = '855790869281-iie5tqafurs5179pmr8s236n595o4460.apps.googleusercontent.com';
    var API_KEY = 'AIzaSyDxKJyIUDRnU7xTz6_CWAGxZkDiytZtpA4';

    // Array of API discovery doc URLs for APIs used by the quickstart
    var DISCOVERY_DOCS = [
      "https://sheets.googleapis.com/$discovery/rest?version=v4",
      "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"
    ];

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    var SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/calendar.readonly";

    var documentID = '1hqNuYTfAguDAXDWA9L14BarfqwVOWSGsd6IpuWNX2BE';

    var authorizeButton = document.getElementById('authorize-button');
    var signoutButton = document.getElementById('signout-button');
    var documentInput = document.getElementById('sheet-input');
    var sheetSubmit = document.getElementById('sheet-submit');
    var sheetDropdown = document.getElementById('sheet-names');
    var randomizeBtn = document.getElementById('pick-activity');
    var pickedActivity = document.getElementById('picked-activity');
    var sheetContentContainer = document.querySelectorAll('[sheet-content]');
    var timeRange = document.querySelector('[time-range]');
    var timeRangeValue = document.querySelector('[time-range-value]');
    var filterSubmit = document.getElementById('filter-submit');
    var removeFiltersBtn = document.getElementById('remove-filters');
    var noActivityContainers = document.querySelectorAll('.no-activity');
    var randomizedActivityContainers = document.querySelectorAll('.randomized-activity');
    var viewListBtns = document.querySelectorAll('[data-target="#viewCurrentActivities"]');

    // The activities array will hold all activities from a sheet
    var filteredActivities = [];
    var activities = [];

    /**
     *  On load, called to load the auth2 library and API client library.
     *  Calls initClient.
     */
    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    /**
     *  Initializes the API client library and sets up sign-in state
     *  listeners.
     */
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function () {
        // Listen for sign-in state changes.
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        // Handle the initial sign-in state.
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;
      });
    }

    /**
     *  Called when the signed in status changes, to update the UI
     *  appropriately. After a sign-in, the API is called.
     */
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'block';
        getSheetNames(documentID);
        listActivities(documentID);
      } else {
        authorizeButton.style.display = 'block';
        signoutButton.style.display = 'none';
      }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick(event) {
      gapi.auth2.getAuthInstance().signIn();
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick(event) {
      gapi.auth2.getAuthInstance().signOut();
    }

    /**
     * Append a pre element to the body containing the given message
     * as its text node. Used to display the results of the API call.
     *
     * @param {string} message Text to be placed in pre element.
     */
    function appendPre(message) {
      var content = document.querySelectorAll('content');
      var textContent = document.createTextNode(message + '\n');
      content.appendChild(textContent);
    }
    function appendCol(activity, time) {
      sheetContentContainer.forEach(contentContainer => {
        var col = document.createElement("div");
        var textContent = document.createTextNode(activity + ", " + time + " minutes." + '\n');
        col.classList.add("col-sm-12");
        col.appendChild(textContent);
        contentContainer.appendChild(col);
      })
    }

    /**
     * Print the names and majors of students in a sample spreadsheet:
     * https://docs.google.com/spreadsheets/d/1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms/edit
     */
    function listActivities(documentID, sheetName) {
      let sheetPrefix = sheetName ? (sheetName + '!') : '';
      sheetContentContainer.forEach(ct => ct.innerHTML = '<div class="col">Loading data...</div>');

      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: documentID || '1hqNuYTfAguDAXDWA9L14BarfqwVOWSGsd6IpuWNX2BE',
        range: sheetPrefix + 'A2:D',
      }).then(function (response) {
        var range = response.result;
        
        // Sometimes range.values has no values so it is not returned from the response
        // This is why it needs to be checked before the length is checked.
        if (range.values && range.values.length > 0) {      
          // Reset the activities array
          activities = [];

          sheetContentContainer.forEach(ct => ct.innerHTML = '');
          for (i = 0; i < range.values.length; i++) {
            var row = range.values[i];

            // Print columns A and B, which correspond to indices 0 and 1.
            appendCol(row[0],row[1]);

            activities.push({
              name: row[0],
              time: row[1],
              rating: row[2],
              description: row[3] || 'No description'
            });
            
          }      
          setTimeRangeMaxValue();
          documentInput.classList.remove('is-invalid');
        } else {

          sheetContentContainer.forEach(ct => ct.innerHTML = '<div class="col">No data found. :(</div>');
          disableFilters();
        }
      }, function (response) {
        documentInput.classList.add('is-invalid');
        disableFilters();
        // documentID = '1hqNuYTfAguDAXDWA9L14BarfqwVOWSGsd6IpuWNX2BE';
        console.log('error: ' + response.result.error.message);
        appendPre('Error: ' + response.result.error.message);
      });
    }

    function getSheetNames(documentID) {
      gapi.client.sheets.spreadsheets.get({
        spreadsheetId: documentID
      }).then(function(response) {
        // console.log("Sheet names response");
        // console.log(response);

        insertSheetNames(response.result.sheets, sheetDropdown); // array        
      }, function(reason) {
        console.error('error: ' + reason.result.error.message);
      });
    }

    function getSheet(documentID, sheetName) {
      listActivities(documentID, sheetName);
    }

    function insertSheetNames(sheetNames, select) {
      // select.style.display = "inline-block";
      select.disabled = true;
      select.innerHTML = '<option>Loading sheet names...</option>';
      sheetNames.forEach(sheet => {
        let sheetName = sheet.properties.title;

        if(sheetName.toLowerCase() !== 'info') {
          let option = document.createElement('option');
          option.text = sheetName;
          option.value = sheetName;
          select.appendChild(option);

          if(option.value.toLowerCase() === 'example template') {
            select.value = option.value;
            // Manually dispatch a change event
            select.dispatchEvent(new Event('change'));
          }
        }        
      });
      select.disabled = false;
    }

    function insertRandomizedActivity(pick) {
      pickedActivity.querySelector('.card-title h2').innerHTML = pick.name;
      pickedActivity.querySelector('.card-text').innerHTML = pick.description + '<br>' + pick.time + ' minutes.';
    }

    sheetDropdown.addEventListener('change', (event) => {
      // documentID = documentInput.value == '' ? documentID : documentInput.value;
      let sheetName = event.target.value;
      listActivities(documentID, sheetName);
    });

    sheetSubmit.addEventListener('click', function() {      
      if((documentInput.value).indexOf('docs.google.com/spreadsheets') > 0) {
        var googleSheetsDocumentIDRegex = new RegExp(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
        // sheet link
        var regexResult = documentInput.value.match(googleSheetsDocumentIDRegex);
        documentID = regexResult[1];
      } else {
        documentID = documentInput.value == '' ? documentID : documentInput.value;
      }

      getSheet(documentID);
      getSheetNames(documentID);
    });

    randomizeBtn.addEventListener('click', () => {
      let theArrayToFilter = filterActivities(activities, checkFilters()); 

      if(theArrayToFilter.length > 0) {
        let random = Math.floor(Math.random()*theArrayToFilter.length);
        insertRandomizedActivity(theArrayToFilter[random]);
        noActivityContainers.forEach(function(el) {
          el.style.display = 'none';
        });
        randomizedActivityContainers.forEach(function(el) {
          el.style.display = 'block';
        });
      } else {
        sheetContentContainer.forEach(ct => ct.innerHTML = '<div class="col">You filtered out all activities in your sheet.</div>');
        console.log('No activities available');
      }
      
    });

    // document.getElementById('clear-input').addEventListener('click', function() {
    //   documentInput.value = '';
    // });

    function setTimeRangeMaxValue(activ) {
      timeRange.disabled = true;
      activ = activ || activities;
      let maxTime = null;

      maxTime = activ.reduce((accumulator, currentActivity) => {
        let time = Number(currentActivity.time);
        return time > accumulator ? time : accumulator;        
      }, null);
      timeRange.max = maxTime;
      timeRange.value = maxTime;
      timeRangeValue.textContent = timeRange.value;
      if(timeRange.disabled == true && timeRange.max != 'null') timeRange.disabled = false;
    }

    function disableFilters() {
      timeRange.disabled = true;
    }

    timeRange.addEventListener('change', function(e) {
      var rangeValue = e.target.value;
      timeRangeValue.textContent = rangeValue;
    });

    function filterActivities(actvts, filters) {
      // filter based on time
      let filtered = actvts.filter((activity) => {
        // Because activity.time is a string it needs to be converted
        // to a number before comparing it to the value of the time range.
        return Number(activity.time) <= filters.maxTime;
      });
      return filtered;
    }

    removeFiltersBtn.addEventListener('click', () => {
      // restore to the original state of the filters
      setTimeRangeMaxValue(activities);
    });
    
    function checkFilters() {
      var filters = {};
      filters.maxTime = timeRange.value;

      return filters;
    }

    viewListBtns.forEach(function(btn) {
      btn.addEventListener('click', function(e){
        var filtered =  filterActivities(activities, checkFilters());
        console.log(filtered);
        if(filtered.length > 0) {
          sheetContentContainer.forEach(ct => ct.innerHTML = '');
          filtered.forEach(function(activity){
            appendCol(activity.name, activity.time);
          });
        } else {
          sheetContentContainer.forEach(ct => ct.innerHTML = '<div class="col">You filtered out all activities in your sheet.</div>');
        }
      });
    });

  </script>

  <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()" onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>
<script type="text/javascript" src="main.bundle.js"></script></body>

</html>